# Features map

## Categorized list of database functions with permissions and remarks, if applicable

| Group                               | Feature                                               | Function                                                                                                             | Permissions | Remarks                                                                                                                                                     |
| ----------------------------------- | ----------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- | ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Database versioning                 | Marks version update start                            | start\_version\_update(\_version text, \_title text, \_description text default null)                                |             |                                                                                                                                                             |
| Database versioning                 | Marks version update end                              | stop\_version\_update(\_version text)                                                                                |             | Just to see how long itthe update took and if it was successful                                                                                             |
| **Helper functions**                |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     | Generate random string                                | helpers.random\_string(len integer DEFAULT 36)                                                                       |             | The function is based on MD5 and just cuts the generated string to desired length                                                                           |
|                                     | Get code from title in plain Latin                    | helpers.get\_code(\_title text, \_separator text default '-')                                                        |             | All whitespaces and special characters are replaced with *\_separator* character (defaults to -) and whole ext is unaccented with *ext.unaccent(text)* function |
|                                     | Get ltree parent X level above                        | helpers.ltree\_parent(path ext.ltree, levels integer DEFAULT 1)                                                      |             |                                                                                                                                                             |
|                                     | Automated code generation from title using trigger    | helpers.trg\_generate\_code\_from\_title()                                                                           |             | Uses helpers.get_code() and expects *title* column in the table                                                                                                                                     |
| **Authorization related functions** |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_auth\_event(\_created\_by text, \_user\_id bigint, \_event\_type\_code text,                        |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_auth\_event(\_created\_by text, \_user\_id bigint, \_event\_type\_code text,                            |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.clear\_permission\_cache(\_deleted\_by text, \_tenant\_id int, \_target\_user\_id bigint)                   |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.recalculate\_user\_groups(\_created\_by text,                                                               |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.recalculate\_user\_permissions(\_created\_by text, \_tenant\_id int, \_target\_user\_id bigint)             |             |                                                                                                                                                             |
|                                     |                                                       | auth.has\_permissions(\_tenant\_id int, \_target\_user\_id bigint, \_perm\_codes text[],                             |             |                                                                                                                                                             |
|                                     |                                                       | auth.has\_permission(\_tenant\_id int, \_target\_user\_id bigint, \_perm\_code text,                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.throw\_no\_access(\_tenant\_id int, \_username text)                                                            |             |                                                                                                                                                             |
|                                     |                                                       | auth.throw\_no\_permission(\_tenant\_id int, \_user\_id bigint, \_perm\_codes text[])                                |             |                                                                                                                                                             |
|                                     |                                                       | auth.throw\_no\_permission(\_tenant\_id int, \_user\_id bigint, \_perm\_code text)                                   |             |                                                                                                                                                             |
|                                     |                                                       | auth.ensure\_groups\_and\_permissions(\_created\_by text, \_user\_id bigint, \_target\_user\_id bigint,              |             |                                                                                                                                                             |
| **Identity provider management**    |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | auth.validate\_provider\_is\_active(\_provider\_code text)                                                           |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_provider(\_created\_by text, \_user\_id bigint, \_provider\_code text, \_provider\_name text,           |             |                                                                                                                                                             |
|                                     |                                                       | auth.update\_provider(\_modified\_by text, \_user\_id bigint, \_provider\_id int, \_provider\_code text,             |             |                                                                                                                                                             |
|                                     |                                                       | auth.delete\_provider(\_deleted\_by text, \_user\_id bigint, \_provider\_code text)                                  |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_provider\_users(\_requested\_by text, \_user\_id bigint, \_provider\_code text)                            |             |                                                                                                                                                             |
|                                     |                                                       | auth.enable\_provider(\_modified\_by text, \_user\_id bigint, \_provider\_code text)                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.disable\_provider(\_modified\_by text, \_user\_id bigint, \_provider\_code text)                                |             |                                                                                                                                                             |
| **Tenant management**               |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_primary\_tenant()                                                                                   |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.delete\_user\_by\_username\_as\_system(\_username text)                                                     |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.expire\_tokens(\_created\_by text)                                                                          |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenants(\_user\_id bigint)                                                                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenant\_by\_id(\_tenant\_id int)                                                                           |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenant\_users(\_requested\_by text, \_user\_id bigint, \_tenant\_id int)                                   |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenant\_groups(\_requested\_by text, \_user\_id bigint, \_tenant\_id int)                                  |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenant\_members(\_requested\_by text, \_user\_id bigint, \_tenant\_id int)                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_tenant\_permissions(\_tenant\_id int, \_user\_id bigint)                                                   |             |                                                                                                                                                             |
|                                     |                                                       | public.assign\_tenant\_owner(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_target\_user\_id bigint)     |             |                                                                                                                                                             |
|                                     |                                                       | public.create\_tenant(\_created\_by text, \_user\_id bigint, \_title text, \_code text default null,                 |             |                                                                                                                                                             |
| **REMOVE**                          |                                                       |                                                                                                                      |             |                                                                                                                                                             |
| TO REMOVE                           |                                                       | unsecure.add\_user\_group\_member(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int,    |             |                                                                                                                                                             |
| TO REMOVE                           |                                                       | unsecure.add\_user\_to\_group\_as\_system(\_user\_name text, \_group\_title text, \_tenant\_id int default null)     |             |                                                                                                                                                             |
| **Permission management**           |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.update\_permission\_full\_title(\_perm\_path ext.ltree)                                                     |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.update\_permission\_full\_code(\_perm\_path ext.ltree)                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_permission\_by\_path\_as\_system(\_title text                                                       |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.assign\_permission(\_created\_by text, \_user\_id bigint, \_tenant\_id int,                                 |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.unassign\_permission(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int,                               |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.set\_permission\_as\_assignable(\_modified\_by text, \_user\_id bigint,                                     |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.assign\_permission\_as\_system(\_tenant\_id int, \_user\_group\_id int, \_target\_user\_id bigint,          |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_perm\_set(                                                                                          |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_perm\_set\_as\_system(                                                                              |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.update\_perm\_set(                                                                                          |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.add\_perm\_set\_permissions(\_created\_by text, \_user\_id bigint, \_tenant\_id int,                        |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.delete\_perm\_set\_permissions(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int,                     |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.update\_last\_used\_provider(\_target\_user\_id bigint, \_provider\_code text)                              |             |                                                                                                                                                             |
|                                     |                                                       | auth.set\_permission\_as\_assignable(\_modified\_by text, \_user\_id bigint,                                         |             |                                                                                                                                                             |
|                                     |                                                       | auth.assign\_permission(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int,              |             |                                                                                                                                                             |
|                                     |                                                       | auth.unassign\_permission(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int, \_assignment\_id int)             |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_permission\_by\_path(\_created\_by text, \_user\_id int,                                                |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_permission\_by\_code(\_created\_by text, \_user\_id int, \_title text,                                  |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_perm\_set(                                                                                              |             |                                                                                                                                                             |
|                                     |                                                       | auth.update\_perm\_set(                                                                                              |             |                                                                                                                                                             |
|                                     |                                                       | auth.add\_perm\_set\_permissions(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_perm\_set\_id int,       |             |                                                                                                                                                             |
|                                     |                                                       | auth.delete\_perm\_set\_permissions(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_perm\_set\_id int,    |             |                                                                                                                                                             |
| **User management**                 |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_system\_user()                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_user\_info(\_created\_by text, \_user\_id bigint, \_username text, \_email text,                    |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_user\_identity(\_created\_by text, \_user\_id bigint, \_target\_user\_id bigint,                    |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.update\_user\_password(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint,                   |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.add\_user\_to\_default\_groups(\_created\_by text, \_user\_id bigint, \_target\_user\_id bigint,            |             |                                                                                                                                                             |
|                                     |                                                       | auth.enable\_user(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint)                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.disable\_user(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint)                                |             |                                                                                                                                                             |
|                                     |                                                       | auth.unlock\_user(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint)                                 |             |                                                                                                                                                             |
|                                     |                                                       | auth.lock\_user(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint)                                   |             |                                                                                                                                                             |
|                                     |                                                       | auth.enable\_user\_identity(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint,                       |             |                                                                                                                                                             |
|                                     |                                                       | auth.disable\_user\_identity(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint,                      |             |                                                                                                                                                             |
|                                     |                                                       | auth.update\_user\_password(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint,                       |             |                                                                                                                                                             |
|                                     |                                                       | auth.add\_user\_to\_default\_groups(\_created\_by text, \_user\_id bigint, \_target\_user\_id bigint,                |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_user\_by\_id(\_user\_id bigint)                                                                            |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_user\_identity(\_user\_id bigint, \_target\_user\_id bigint, \_provider\_code text)                        |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_user\_identity\_by\_email(\_user\_id bigint, \_email text, \_provider\_code text)                          |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_user\_by\_email\_for\_authentication(\_user\_id int, \_email text)                                         |             |                                                                                                                                                             |
|                                     |                                                       | auth.ensure\_user\_from\_provider(\_created\_by text, \_user\_id bigint, \_provider\_code text,                      |             |                                                                                                                                                             |
|                                     |                                                       | auth.update\_user\_data(\_modified\_by text, \_user\_id bigint, \_target\_user\_id bigint, \_provider text,          |             |                                                                                                                                                             |
|                                     |                                                       | auth.get\_user\_random\_code()                                                                                       |             |                                                                                                                                                             |
| **User group management**           |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_user\_group(\_created\_by text, \_user\_id bigint, \_title text                                     |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.create\_user\_group\_as\_system(\_tenant\_id int, \_title text                                              |             |                                                                                                                                                             |
|                                     |                                                       | unsecure.get\_user\_group\_members(\_requested\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int) |             |                                                                                                                                                             |
|                                     | create user group                                     | auth.create\_user\_group(\_created\_by text, \_user\_id bigint, \_title text, \_tenant\_id int,                      |             |                                                                                                                                                             |
|                                     | update user group                                     | auth.update\_user\_group(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_ug\_id int, \_title text,       |             |                                                                                                                                                             |
|                                     | enable user group                                     | auth.enable\_user\_group(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)            |             |                                                                                                                                                             |
|                                     | disable user group                                    | auth.disable\_user\_group(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)           |             |                                                                                                                                                             |
|                                     | lock user group                                       | auth.lock\_user\_group(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)              |             |                                                                                                                                                             |
|                                     | unlock user group                                     | auth.unlock\_user\_group(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)            |             |                                                                                                                                                             |
|                                     | delete user group                                     | auth.delete\_user\_group(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)             |             |                                                                                                                                                             |
|                                     | add user to user group                                | auth.create\_user\_group\_member(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int,     |             |                                                                                                                                                             |
|                                     | remove user from user group                           | auth.delete\_user\_group\_member(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int, \_ug\_id int,              |             |                                                                                                                                                             |
|                                     | get user group members                                | auth.get\_user\_group\_members(\_requested\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)     |             |                                                                                                                                                             |
|                                     | create user group mapping                             | auth.create\_user\_group\_mapping(\_created\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int,    |             |                                                                                                                                                             |
|                                     | delete user group mapping                             | auth.delete\_user\_group\_mapping(\_deleted\_by text, \_user\_id bigint, \_tenant\_id int, \_ug\_mapping\_id int)    |             |                                                                                                                                                             |
|                                     | create external user group                            | auth.create\_external\_user\_group(\_created\_by text, \_user\_id bigint, \_title text, \_tenant\_id int,            |             |                                                                                                                                                             |
|                                     |                                                       | auth.set\_user\_group\_as\_external(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int) |             |                                                                                                                                                             |
|                                     |                                                       | auth.set\_user\_group\_as\_hybrid(\_modified\_by text, \_user\_id bigint, \_tenant\_id int, \_user\_group\_id int)   |             |                                                                                                                                                             |
|                                     |                                                       | auth.register\_user(\_created\_by text, \_user\_id int, \_email text, \_password\_hash text,                         |             |                                                                                                                                                             |
| **Public general functions**        |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | add\_journal\_msg\_jsonb(\_created\_by text, \_tenant\_id int, \_user\_id bigint, \_msg text,                        |             |                                                                                                                                                             |
|                                     |                                                       | add\_journal\_msg(\_created\_by text, \_tenant\_id int, \_user\_id bigint, \_msg text,                               |             |                                                                                                                                                             |
|                                     |                                                       | get\_journal\_msgs(\_tenant\_id int, \_user\_id int, \_from timestamptz, \_to timestamptz)                           |             |                                                                                                                                                             |
|                                     |                                                       | get\_journal\_payload(\_tenant\_id int, \_user\_id int, \_journal\_id bigint)                                        |             |                                                                                                                                                             |
|                                     |                                                       | public.calculate\_roles\_and\_permissions(\_user\_id bigint, \_provider\_groups text[], \_provider\_roles text[])    |             |                                                                                                                                                             |
|                                     |                                                       | load\_initial\_data()                                                                                                |             |                                                                                                                                                             |
| **Token management functions**      |                                                       |                                                                                                                      |             |                                                                                                                                                             |
|                                     |                                                       | auth.create\_token(\_created\_by text, \_user\_id bigint,                                                            |             |                                                                                                                                                             |
|                                     |                                                       | auth.validate\_token(\_modified\_by text, \_user\_id bigint,                                                         |             |                                                                                                                                                             |
|                                     |                                                       | auth.set\_token\_as\_used(\_modified\_by text, \_user\_id bigint, \_token\_id bigint,                                |             |                                                                                                                                                             |
| **Authorized functions**            |                                                       |                                                                                                                      |             |                                                                                                                                                             |
| Authentication                      | Ensure user from external identity provider           |                                                                                                                      |             |                                                                                                                                                             |
| Authentication                      | Ensure user's groups and permissions                  |                                                                                                                      |             | Also based on groups and roles coming from identity provider                                                                                                |
| Authentication                      | Ensure user's groups and permissions                  |                                                                                                                      |             | Also based on groups and roles coming from identity provider                                                                                                |
| **Error raising functions**         |                                                       |                                                                                                                      |             |                                                                                                                                                             |
| Error handling                      | Throws 52101 error to stop processing of the function | error.raise\_52101(\_username text)                                                                                  |             |                                                                                                                                                             |
| Error handling                      | Throws 52102 error to stop processing of the function | error.raise\_52102(\_normalized\_email text)                                                                         |             |                                                                                                                                                             |
| Error handling                      | Throws 52103 error to stop processing of the function | error.raise\_52103(\_user\_id bigint, \_email text default null)                                                     |             |                                                                                                                                                             |
| Error handling                      | Throws 52104 error to stop processing of the function | error.raise\_52104(\_user\_id bigint)                                                                                |             |                                                                                                                                                             |
| Error handling                      | Throws 52105 error to stop processing of the function | error.raise\_52105(\_user\_id bigint)                                                                                |             |                                                                                                                                                             |
| Error handling                      | Throws 52106 error to stop processing of the function | error.raise\_52106(\_email text)                                                                                     |             |                                                                                                                                                             |
| Error handling                      | Throws 52107 error to stop processing of the function | error.raise\_52107(\_provider\_code text)                                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52108 error to stop processing of the function | error.raise\_52108(\_tenant\_id text, \_username text)                                                               |             |                                                                                                                                                             |
| Error handling                      | Throws 52109 error to stop processing of the function | error.raise\_52109(\_user\_id bigint, \_tenant\_id int, \_perm\_codes text[])                                        |             |                                                                                                                                                             |
| Error handling                      | Throws 52110 error to stop processing of the function | error.raise\_52110(\_user\_id bigint, \_provider\_code text)                                                         |             |                                                                                                                                                             |
| Error handling                      | Throws 52111 error to stop processing of the function | error.raise\_52111(\_user\_id bigint, \_provider\_code text)                                                         |             |                                                                                                                                                             |
| Error handling                      | Throws 52112 error to stop processing of the function | error.raise\_52112(\_user\_id bigint)                                                                                |             |                                                                                                                                                             |
| Error handling                      | Throws 52171 error to stop processing of the function | error.raise\_52171(\_user\_group\_id int)                                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52172 error to stop processing of the function | error.raise\_52172(\_user\_group\_id int)                                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52173 error to stop processing of the function | error.raise\_52173(\_user\_group\_id int)                                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52174 error to stop processing of the function | error.raise\_52174()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52175 error to stop processing of the function | error.raise\_52175(\_perm\_set\_code text)                                                                           |             |                                                                                                                                                             |
| Error handling                      | Throws 52176 error to stop processing of the function | error.raise\_52176(\_perm\_set\_code text)                                                                           |             |                                                                                                                                                             |
| Error handling                      | Throws 52177 error to stop processing of the function | error.raise\_52177(\_perm\_set\_id int, \_tenant\_id int)                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52178 error to stop processing of the function | error.raise\_52178()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52271 error to stop processing of the function | error.raise\_52271(\_user\_group\_id int)                                                                            |             |                                                                                                                                                             |
| Error handling                      | Throws 52272 error to stop processing of the function | error.raise\_52272()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52273 error to stop processing of the function | error.raise\_52273()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52274 error to stop processing of the function | error.raise\_52274()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52275 error to stop processing of the function | error.raise\_52275(\_permission\_full\_code text)                                                                    |             |                                                                                                                                                             |
| Error handling                      | Throws 52276 error to stop processing of the function | error.raise\_52276()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52277 error to stop processing of the function | error.raise\_52277()                                                                                                 |             |                                                                                                                                                             |
| Error handling                      | Throws 52278 error to stop processing of the function | error.raise\_52278(\_token\_uid text)                                                                                |             |                                                                                                                                                             |
| Error handling                      | Throws 52279 error to stop processing of the function | error.raise\_52279(\_token\_uid text)                                                                                |             |                                                                                                                                                             |
